<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cart - Crochet Arty</title>
  <link rel="stylesheet" href="css/style.css">
  <script defer src="js/api.js"></script>
</head>
<body class="bg-gradient min-h-screen flex flex-col">
  <nav class="navbar">
    <span class="logo">Crochet Arty</span>
    <div class="nav-links">
      <a href="home.html">Home</a>
      <a href="cart.html" class="active">Cart</a>
      <a href="wishlist.html">Wishlist</a>
      <a href="orders.html">Orders</a>
      <a href="profile.html" id="profileNav">Profile</a>
      <a href="dashboard.html" id="dashboardLink" style="display: none;">Dashboard</a>
      <a href="#" id="logoutLink" class="logout">Logout</a>
    </div>
  </nav>
  <main class="main-content">
    <h1 class="section-title">Your Cart</h1>
    <div id="cartItems" class="cart-items">
      <div class="loading">Loading cart...</div>
    </div>
    <div id="cartSummary" class="cart-summary"></div>
    <div id="buyModal" class="modal" style="display:none;">
      <div class="modal-content">
        <div id="modalStep1" style="display:none;">
          <h2 class="modal-title">Enter Delivery Address</h2>
          <textarea id="addressInput" class="modal-input" rows="3" placeholder="Enter your address..."></textarea>
          <button class="btn btn-primary" id="continueToReturn">Continue</button>
        </div>
        <div id="modalStep2" style="display:none;">
          <h2 class="modal-title">7 Days Return Policy</h2>
          <p>You are eligible for a 7 days return policy from the date of delivery.</p>
          <button class="btn btn-primary" id="acceptReturnPolicy">Okay</button>
        </div>
        <div id="modalStep3" style="display:none;">
          <h2 class="modal-title">Order Summary</h2>
          <div id="orderSummary"></div>
          <div id="knotsSection"></div>
          <button class="btn btn-hero" id="placeOrder">Place Order</button>
        </div>
      </div>
    </div>
    <div id="modalOverlay" class="modal-overlay" style="display:none;"></div>
  </main>
  
  <script>
    let cartData = null;

    // Initialize cart page
    async function initializeCart() {
      if (!API.helpers.isAuthenticated()) {
        showNotification('Please login to view your cart', 'info');
        return;
      }

      try {
        await loadCart();
        setupEventListeners();
      } catch (error) {
        console.error('Failed to initialize cart:', error);
        showError('Failed to load cart. Please try again.');
      }
    }

    // Load cart from API
    async function loadCart() {
      try {
        const response = await API.cart.getCart();
        
        if (response.success) {
          cartData = response.data.cart;
          renderCart();
        } else {
          showError('Failed to load cart.');
        }
      } catch (error) {
        console.error('Load cart error:', error);
        showError('Failed to load cart. Please try again.');
      }
    }

    // Render cart
    function renderCart() {
      const itemsDiv = document.getElementById('cartItems');
      const summaryDiv = document.getElementById('cartSummary');
      
      if (!cartData || cartData.items.length === 0) {
        itemsDiv.innerHTML = '<div class="no-products">Your cart is empty.</div>';
        summaryDiv.innerHTML = '';
        return;
      }

      itemsDiv.innerHTML = '';
      
      cartData.items.forEach(item => {
        const product = item.product;
        const itemDiv = document.createElement('div');
        itemDiv.className = 'cart-item';
        itemDiv.innerHTML = `
          <img src="${product.images && product.images[0] ? product.images[0] : 'images/placeholder.jpg'}" alt="${product.title}" class="cart-item-img">
          <div class="cart-item-info">
            <h2 class="product-title">${product.title}</h2>
            <p class="product-price">${API.helpers.formatPrice(product.price)}</p>
            <div class="cart-item-actions">
              <label>Qty:</label>
              <input type="number" min="1" max="99" value="${item.quantity}" class="cart-qty" 
                     data-product-id="${product._id}">
              <button class="btn btn-outline remove-btn" data-product-id="${product._id}">Remove</button>
            </div>
          </div>
        `;
        itemsDiv.appendChild(itemDiv);
      });

      // Add event listeners for quantity changes and remove buttons
      setupCartEventListeners();

      // Render summary
      summaryDiv.innerHTML = `
        <div class="cart-summary-bar">
          <span class="cart-total-label">Total:</span>
          <span class="cart-total-value">${API.helpers.formatPrice(cartData.totalAmount)}</span>
        </div>
        <div class="cart-actions">
          <button class="btn btn-primary btn-large" onclick="proceedToCheckout()">Proceed to Checkout</button>
          <button class="btn btn-outline" onclick="clearCart()">Clear Cart</button>
        </div>
      `;
    }

    // Setup event listeners for cart items
    function setupCartEventListeners() {
      // Quantity change listeners
      document.querySelectorAll('.cart-qty').forEach(input => {
        input.addEventListener('change', function() {
          const productId = this.getAttribute('data-product-id');
          const quantity = parseInt(this.value);
          updateQuantity(productId, quantity);
        });
      });

      // Remove button listeners
      document.querySelectorAll('.remove-btn').forEach(button => {
        button.addEventListener('click', function() {
          const productId = this.getAttribute('data-product-id');
          removeFromCart(productId);
        });
      });
    }

    // Update quantity
    async function updateQuantity(productId, quantity) {
      try {
        console.log('Updating quantity for product:', productId, 'to:', quantity);
        const response = await API.cart.updateCartItem(productId, quantity);
        
        if (response.success) {
          cartData = response.data.cart;
          renderCart();
          showSuccess('Quantity updated successfully.');
        } else {
          showError('Failed to update quantity.');
        }
      } catch (error) {
        console.error('Update quantity error:', error);
        showError('Failed to update quantity. Please try again.');
      }
    }

    // Remove from cart
    async function removeFromCart(productId) {
      try {
        console.log('Removing product from cart:', productId);
        const response = await API.cart.removeFromCart(productId);
        
        if (response.success) {
          cartData = response.data.cart;
          renderCart();
          showSuccess('Item removed from cart.');
        } else {
          showError('Failed to remove item.');
        }
      } catch (error) {
        console.error('Remove from cart error:', error);
        showError('Failed to remove item. Please try again.');
      }
    }

    // Clear cart
    async function clearCart() {
      if (!confirm('Are you sure you want to clear your cart?')) return;
      
      try {
        const response = await API.cart.clearCart();
        
        if (response.success) {
          cartData = response.data.cart;
          renderCart();
          showSuccess('Cart cleared successfully.');
        } else {
          showError('Failed to clear cart.');
        }
      } catch (error) {
        console.error('Clear cart error:', error);
        showError('Failed to clear cart. Please try again.');
      }
    }

    // Proceed to checkout
    function proceedToCheckout() {
      if (!cartData || cartData.items.length === 0) {
        showError('Your cart is empty.');
        return;
      }
      
      window.location.href = 'checkout.html';
    }

    // Setup general event listeners
    function setupEventListeners() {
      // Logout functionality
      const logoutLink = document.getElementById('logoutLink');
      if (logoutLink) {
        logoutLink.addEventListener('click', async function(e) {
          e.preventDefault();
          try {
            await API.auth.logout();
          } catch (error) {
            console.error('Logout error:', error);
          }
        });
      }

      // Profile navigation
      const profileNav = document.getElementById('profileNav');
      const dashboardLink = document.getElementById('dashboardLink');
      
      if (API.helpers.isAuthenticated()) {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (profileNav) profileNav.style.display = 'inline';
        if (user.role === 'artisan' || user.role === 'admin') {
          if (dashboardLink) dashboardLink.style.display = 'inline';
        }
      }
    }

    // Show notification
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Show error message
    function showError(message) {
      showNotification(message, 'error');
    }

    // Show success message
    function showSuccess(message) {
      showNotification(message, 'success');
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', initializeCart);
  </script>
</body>
</html> 